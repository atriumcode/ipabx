; ==================================================================
; DIALPLAN - PBX MODERNO ENTERPRISE
; Plano de discagem inteligente com suporte a multitenant
; ==================================================================

[general]
static=yes
writeprotect=no
clearglobalvars=no
priorityjumping=yes

[globals]
; Definições globais
SISTEMA=PBX Moderno Enterprise
TIMEOUT_RESPOSTA=20
TIMEOUT_DIGITO=5

; ==================================================================
; CONTEXTO: from-internal (Ramais Internos)
; ==================================================================
[from-internal]
; Chamadas entre ramais
exten => _[1-9]XXX,1,NoOp(Chamada interna de ${CALLERID(num)} para ${EXTEN})
 same => n,Set(CALLERID(name)=${DB(extension/${CALLERID(num)}/name)})
 same => n,Dial(PJSIP/${EXTEN},${TIMEOUT_RESPOSTA},tT)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy:unavail)
 same => n(unavail),VoiceMail(${EXTEN}@default,u)
 same => n,Hangup()
 same => n(busy),VoiceMail(${EXTEN}@default,b)
 same => n,Hangup()

; Captura de chamada (*8)
exten => *8,1,NoOp(Captura de chamada)
 same => n,Pickup()
 same => n,Hangup()

; Correio de voz (*98)
exten => *98,1,NoOp(Acesso ao correio de voz)
 same => n,VoiceMailMain(${CALLERID(num)}@default)
 same => n,Hangup()

; Echo Test (*43)
exten => *43,1,NoOp(Teste de Echo)
 same => n,Answer()
 same => n,Playback(beep)
 same => n,Echo()
 same => n,Hangup()

; Música em espera (*60)
exten => *60,1,NoOp(Teste de música em espera)
 same => n,Answer()
 same => n,MusicOnHold()
 same => n,Hangup()

; Chamadas para filas (6XXX)
exten => _6XXX,1,NoOp(Chamada para fila ${EXTEN})
 same => n,Answer()
 same => n,Queue(${EXTEN},tT,,,300)
 same => n,Hangup()

; Chamadas para URAs (5XXX)
exten => _5XXX,1,NoOp(Chamada para URA ${EXTEN})
 same => n,Answer()
 same => n,Goto(ura-${EXTEN},s,1)
 same => n,Hangup()

; Chamadas externas (0 + número ou 9 + número)
exten => _0.,1,NoOp(Chamada externa via prefixo 0)
 same => n,Goto(from-internal-outbound,${EXTEN:1},1)

exten => _9.,1,NoOp(Chamada externa via prefixo 9)
 same => n,Goto(from-internal-outbound,${EXTEN:1},1)

; Chamadas internacionais (00)
exten => _00.,1,NoOp(Chamada internacional)
 same => n,Goto(from-internal-outbound,${EXTEN},1)

; ==================================================================
; CONTEXTO: from-internal-outbound (Rotas de Saída)
; ==================================================================
[from-internal-outbound]
; Rota para números locais (10 dígitos)
exten => _NXXXXXXXXX,1,NoOp(Chamada local para ${EXTEN})
 same => n,Set(CDR(accountcode)=${CALLERID(num)})
 same => n,Set(CALLERID(num)=${IF($[${LEN(${CALLERID(num)})} > 4]?${CALLERID(num)}:1000)})
 same => n,Dial(PJSIP/${EXTEN}@trunk-principal,60,tT)
 same => n,GotoIf($["${DIALSTATUS}" = "CHANUNAVAIL"]?trunk2:fim)
 same => n(trunk2),Dial(PJSIP/${EXTEN}@trunk-backup,60,tT)
 same => n(fim),Hangup()

; Rota para números móveis (11 dígitos)
exten => _NXXXXXXXXXXX,1,NoOp(Chamada móvel para ${EXTEN})
 same => n,Set(CDR(accountcode)=${CALLERID(num)})
 same => n,Dial(PJSIP/${EXTEN}@trunk-principal,60,tT)
 same => n,Hangup()

; Rota internacional
exten => _00.,1,NoOp(Chamada internacional para ${EXTEN})
 same => n,Set(CDR(accountcode)=${CALLERID(num)})
 same => n,Dial(PJSIP/${EXTEN}@trunk-internacional,120,tT)
 same => n,Hangup()

; Bloqueio de números especiais (190, 192, 193, etc)
exten => _19X,1,NoOp(Bloqueio de número especial ${EXTEN})
 same => n,Playback(ss-noservice)
 same => n,Hangup()

; ==================================================================
; CONTEXTO: from-trunk (Chamadas Recebidas de Troncos)
; ==================================================================
[from-trunk]
; Tratamento de chamadas entrantes
exten => _X.,1,NoOp(Chamada recebida no DID ${EXTEN})
 same => n,Set(DID=${EXTEN})
 same => n,Set(__FROM_DID=${EXTEN})
 same => n,Gosub(sub-record-check,s,1(in,${EXTEN},${CALLERID(num)}))
 same => n,Goto(from-did-${EXTEN},s,1)

; DID não configurado
exten => s,1,NoOp(DID não identificado)
 same => n,Answer()
 same => n,Playback(ss-noservice)
 same => n,Hangup()

; ==================================================================
; CONTEXTO: from-did-XXXX (Rotas de Entrada por DID)
; ==================================================================
; Exemplo de rota para DID específico
[from-did-1140001234]
exten => s,1,NoOp(Rota de entrada para DID 1140001234)
 same => n,Answer()
 same => n,Playback(welcome)
 same => n,Queue(6001,tT,,,300)
 same => n,VoiceMail(1000@default,u)
 same => n,Hangup()

; ==================================================================
; CONTEXTO: URAs (IVR)
; ==================================================================
[ura-5000]
exten => s,1,NoOp(URA Principal)
 same => n,Answer()
 same => n,Set(TIMEOUT(digit)=${TIMEOUT_DIGITO})
 same => n,Set(TIMEOUT(response)=${TIMEOUT_RESPOSTA})
 same => n(inicio),Background(ura-principal)
 same => n,WaitExten(5)
 same => n,Goto(inicio)

exten => 1,1,NoOp(Opção 1 - Vendas)
 same => n,Goto(from-internal,6001,1)

exten => 2,1,NoOp(Opção 2 - Suporte)
 same => n,Goto(from-internal,6002,1)

exten => 3,1,NoOp(Opção 3 - Financeiro)
 same => n,Goto(from-internal,6003,1)

exten => 9,1,NoOp(Opção 9 - Atendente)
 same => n,Goto(from-internal,1000,1)

exten => 0,1,NoOp(Opção 0 - Repetir)
 same => n,Goto(s,inicio)

exten => i,1,NoOp(Opção inválida)
 same => n,Playback(invalid)
 same => n,Goto(s,inicio)

exten => t,1,NoOp(Timeout)
 same => n,Playback(vm-goodbye)
 same => n,Hangup()

; ==================================================================
; SUBROTINAS
; ==================================================================
[sub-record-check]
; Verificar se deve gravar a chamada
exten => s,1,NoOp(Verificando gravação para ${ARG1} - ${ARG2})
 same => n,Set(REC_POLICY=${DB(record/policy)})
 same => n,GotoIf($["${REC_POLICY}" = "all"]?gravar:nao_gravar)
 same => n(gravar),MixMonitor(${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}-${ARG2}-${UNIQUEID}.wav,b)
 same => n(nao_gravar),Return()

; ==================================================================
; CONTEXTO: Emergência
; ==================================================================
[emergency]
exten => 190,1,NoOp(Chamada para Polícia)
 same => n,Dial(PJSIP/190@trunk-emergencia)
 same => n,Hangup()

exten => 192,1,NoOp(Chamada para SAMU)
 same => n,Dial(PJSIP/192@trunk-emergencia)
 same => n,Hangup()

exten => 193,1,NoOp(Chamada para Bombeiros)
 same => n,Dial(PJSIP/193@trunk-emergencia)
 same => n,Hangup()
